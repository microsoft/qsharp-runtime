##
# Build and test the simulation framework on Windows.
##
steps:
- task: NuGetToolInstaller@0
  displayName: 'Use NuGet 4.9.3'
  inputs:
    versionSpec: '4.9.3'


- script: bootstrap.cmd
  displayName: "Bootstraping environment"
  workingDirectory: $(SimulationSrcDir)/../


- script: |
    cmake --build . --config $(BuildConfiguration)
    ctest -C $(BuildConfiguration)
  displayName: "Build and test Native QuantumSimulator"
  workingDirectory: $(SimulationSrcDir)/Simulation/Native/build


- task: DotNetCoreCLI@2
  displayName: 'Build C# code generation'
  inputs:
    command: build
    arguments: >
      -c $(BuildConfiguration)
      -v $(Build.Verbosity)
      /p:DefineConstants=$(Assembly.Constants)
      /p:Version=$(Assembly.Version)
    projects: '$(SimulationSrcDir)/Simulation/CsharpGeneration.App'


- task: DotNetCoreCLI@2
  displayName: 'Build Q# simulation'
  inputs:
    command: build
    arguments: >
      -c $(BuildConfiguration)
      -v $(Build.Verbosity)
      /p:DefineConstants=$(Assembly.Constants)
      /p:Version=$(Assembly.Version)
      /p:QsharpDocsOutDir=$(DocsOutDir)
    projects: '$(SimulationSrcDir)/../Simulation.sln'


- task: DotNetCoreCLI@2
  displayName: 'Test Q# simulation'
  inputs:
    command: test
    arguments: >
      -c $(BuildConfiguration)
      -v $(Build.Verbosity)
      /p:DefineConstants=$(Assembly.Constants)
      /p:Version=$(Assembly.Version)
    projects: |
      $(SimulationSrcDir)/Simulation/CsharpGeneration.Tests/Tests.CsharpGeneration.fsproj
      $(SimulationSrcDir)/Simulation/RoslynWrapper.Tests/Tests.RoslynWrapper.fsproj
      $(SimulationSrcDir)/Simulation/QCTraceSimulator.Tests/Tests.Microsoft.Quantum.Simulation.QCTraceSimulatorRuntime.csproj
      $(SimulationSrcDir)/Simulation/Simulators.Tests/Tests.Microsoft.Quantum.Simulation.Simulators.csproj
