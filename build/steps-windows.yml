##
# Build, test and pack the simulation framework on Windows.
##
steps:
- script: bootstrap.cmd
  displayName: "Bootstraping environment"
  workingDirectory: $(SimulationSrcDir)


- script: |
    cmake --build . --config $(BuildConfiguration)
    ctest -C $(BuildConfiguration)
  displayName: "Build and test Native QuantumSimulator"
  workingDirectory: $(SimulationSrcDir)/Native/build


- task: DotNetCoreCLI@2
  displayName: 'Build C# code generation'
  inputs:
    command: build
    arguments: >
      -c $(BuildConfiguration)
      -v $(Build.Verbosity)
      /p:DefineConstants=$(Assembly.Constants)
      /p:Version=$(Assembly.Version)
    projects: '$(SimulationSrcDir)/CsharpGeneration/Microsoft.Quantum.CsharpGeneration.fsproj'


- task: DotNetCoreCLI@2
  displayName: 'Build Q# simulation'
  inputs:
    command: build
    arguments: >
      -c $(BuildConfiguration)
      -v $(Build.Verbosity)
      /p:DefineConstants=$(Assembly.Constants)
      /p:Version=$(Assembly.Version)
      /p:QsharpDocsOutDir=$(DocsOutDir)
    projects: |
      $(SimulationSrcDir)/CsharpGenerationApp
      $(SimulationSrcDir)/../Simulation.sln


- task: DotNetCoreCLI@2
  displayName: 'Test Q# simulation'
  inputs:
    command: test
    arguments: >
      -c $(BuildConfiguration)
      -v $(Build.Verbosity)
      /p:DefineConstants=$(Assembly.Constants)
      /p:Version=$(Assembly.Version)
    projects: |
      $(SimulationSrcDir)/CsharpGeneration.Tests/Tests.CsharpGeneration.fsproj
      $(SimulationSrcDir)/RoslynWrapper.Tests/Tests.RoslynWrapper.fsproj
      $(SimulationSrcDir)/QCTraceSimulator.Tests/Tests.Microsoft.Quantum.Simulation.QCTraceSimulatorRuntime.csproj
      $(SimulationSrcDir)/Simulators.Tests/Tests.Microsoft.Quantum.Simulation.Simulators.csproj

- task: NuGetCommand@2
  displayName: 'Package Q# Simulation'
  inputs:
    command: pack
    packagesToPack: >
      $(SimulationSrcDir)\CsharpGeneration\Microsoft.Quantum.CsharpGeneration.fsproj;
      $(SimulationSrcDir)\Simulators\Microsoft.Quantum.Simulators.csproj;
    versioningScheme: byEnvVar
    versionEnvVar: NUGET_VERSION
    packDestination: '$(NugetsOutDir)'
    includeReferencedProjects: true

