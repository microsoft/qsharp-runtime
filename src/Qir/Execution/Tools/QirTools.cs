// Copyright (c) Microsoft Corporation.
// Licensed under the MIT License.

using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.Quantum.Qir.Tools.Executable;
using Microsoft.Quantum.QsCompiler;
using Microsoft.Quantum.QsCompiler.QIR;

namespace Microsoft.Quantum.Qir.Tools
{
    /// <summary>
    /// Provides high-level utility methods to work with QIR.
    /// </summary>
    public static class QirTools
    {
        /// <summary>
        /// Creates a QIR-based executable from a .NET DLL generated by the Q# compiler.
        /// </summary>
        /// <param name="qsharpDll">.NET DLL generated by the Q# compiler.</param>
        /// <param name="libraryDirectory">Directory where the libraries to link to are located.</param>
        /// <param name="includeDirectory">Directory where the headers needed for compilation are located.</param>
        /// <param name="executablesDirectory">Directory where the created executables are placed.</param>
        public static async Task BuildFromQSharpDll(
            FileInfo qsharpDll,
            DirectoryInfo libraryDirectory,
            DirectoryInfo includeDirectory,
            DirectoryInfo executablesDirectory)
        {
            await Foo(qsharpDll, libraryDirectory, includeDirectory, executablesDirectory);

            //using var qirContentStream = new MemoryStream();
            //if (!AssemblyLoader.LoadQirByteCode(qsharpDll, qirContentStream))
            //{
            //    throw new ArgumentException("The given DLL does not contain QIR byte code.");
            //}
            //
            //if (!executablesDirectory.Exists)
            //{
            //    executablesDirectory.Create();
            //}
            //
            //var tasks = EntryPointOperationLoader.LoadEntryPointOperations(qsharpDll).Select(entryPointOp =>
            //{
            //    var exeFileInfo = new FileInfo(Path.Combine(executablesDirectory.FullName, entryPointOp.Name));
            //    var exe = new QirFullStateExecutable(exeFileInfo, qirContentStream.ToArray());
            //    return exe.BuildAsync(entryPointOp, libraryDirectory, includeDirectory);
            //});
            //
            //await Task.WhenAll(tasks);

            // ToDo: Return list of created file names
        }

        private static async Task<int> Foo(
            FileInfo qsharpDll,
            DirectoryInfo libraryDirectory,
            DirectoryInfo includeDirectory,
            DirectoryInfo executablesDirectory)
        {
            Console.WriteLine("From BuildFromQSharpDll!");

            Console.WriteLine("QsharpDll:");
            Console.WriteLine($"\t{qsharpDll}");
            Console.WriteLine("LibraryDirectory:");
            Console.WriteLine($"\t{libraryDirectory}");
            Console.WriteLine("IncludeDirectory:");
            Console.WriteLine($"\t{includeDirectory}");
            Console.WriteLine("ExecutablesDirectory:");
            Console.WriteLine($"\t{executablesDirectory}");

            return 0;
        }
    }
}
